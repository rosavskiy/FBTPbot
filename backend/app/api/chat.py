"""
API эндпоинты чата — основной интерфейс пользователя.
"""

from __future__ import annotations

import logging
from typing import Optional

from fastapi import APIRouter, Depends, Request
from sqlalchemy.ext.asyncio import AsyncSession

from app.database.models import get_db
from app.database.service import DatabaseService
from app.models.schemas import ChatRequest, ChatResponse
from app.rag.engine import get_rag_engine

logger = logging.getLogger(__name__)
router = APIRouter(prefix="/api/chat", tags=["chat"])


@router.post("", response_model=ChatResponse)
async def send_message(
    request: ChatRequest,
    http_request: Request,
    db: AsyncSession = Depends(get_db),
):
    """
    Отправка сообщения в чат техподдержки.

    Если session_id не указан — создаётся новая сессия.
    """
    db_service = DatabaseService(db)
    rag_engine = get_rag_engine()

    # Получаем или создаём сессию
    session = None
    if request.session_id:
        session = await db_service.get_session(request.session_id)

    if session is None:
        session = await db_service.create_session(
            user_ip=http_request.client.host if http_request.client else None,
            user_agent=http_request.headers.get("user-agent"),
        )

    # Сохраняем сообщение пользователя
    await db_service.add_message(
        session_id=session.id,
        role="user",
        content=request.message,
    )

    # Получаем историю чата для контекста
    history_messages = await db_service.get_chat_history(session.id, limit=10)
    chat_history = [
        {"role": msg.role, "content": msg.content}
        for msg in history_messages[:-1]  # Исключаем только что добавленное
    ]

    # Запрос к RAG
    rag_response = await rag_engine.ask(
        question=request.message,
        chat_history=chat_history,
    )

    # Сохраняем ответ бота
    await db_service.add_message(
        session_id=session.id,
        role="assistant",
        content=rag_response.answer,
        confidence=rag_response.confidence,
        source_articles=rag_response.source_articles,
    )

    return ChatResponse(
        answer=rag_response.answer,
        session_id=session.id,
        confidence=rag_response.confidence,
        needs_escalation=rag_response.needs_escalation,
        source_articles=rag_response.source_articles,
        youtube_links=rag_response.youtube_links,
        has_images=bool(rag_response.images),
    )
